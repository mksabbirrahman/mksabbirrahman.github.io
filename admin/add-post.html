<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Add Post — Admin</title>
    <link rel="stylesheet" href="../style.css" />
    <style>
      main { margin:4rem 10rem; }
      form { max-width:900px; display:flex; flex-direction:column; gap:0.75rem }
      input[type=text], textarea { padding:0.6rem; border-radius:8px; border:1px solid #ddd; }
      .actions { margin-top:1rem; display:flex; gap:0.5rem }
      .result { margin-top:1rem; white-space:pre-wrap; background:#f7f9fc; padding:0.75rem; border-radius:8px; border:1px solid #e2eefb }
      .hint { font-size:0.9rem; color:#555 }
    </style>
  </head>
  <body>
    <script>
      // Admin tools have been removed. Redirect to home.
      window.location.href = '../';
    </script>
    <nav id="desktop-nav">
      <div class="logo">Sabbir Hossen</div>
      <div>
        <ul class="nav-links">
          <li><a href="../">Home</a></li>
          <li><a href="../quotes.html">Quotes</a></li>
        </ul>
      </div>
    </nav>

    <main>
      <h1 class="title">Add Post (Admin)</h1>
      <p class="hint">This page helps you build a new post entry. It will create an updated `posts.json` and a per-post HTML file you can download and commit to `posts/`.</p>

      <form id="post-form">
        <label>Title</label>
        <input id="title" type="text" required />

        <label>Slug (url-friendly; e.g. my-first-post)</label>
        <input id="slug" type="text" placeholder="auto-generated if blank" />

        <label>Date</label>
        <input id="date" type="text" placeholder="YYYY-MM-DD" />

        <label>Excerpt</label>
        <input id="excerpt" type="text" />

        <label>Content (HTML allowed)</label>
        <textarea id="content" rows="8"></textarea>

        <div class="actions">
          <button id="preview" class="btn btn-color-2" type="button">Preview & Build</button>
          <button id="download-json" class="btn btn-color-2" type="button">Download posts.json</button>
          <button id="download-post" class="btn btn-color-1" type="button">Download post HTML</button>
        </div>
      </form>

      <div id="result" class="result"></div>
    </main>

    <script>
      function slugify(s) { return s.toString().toLowerCase().trim().replace(/[^a-z0-9-]+/g,'-').replace(/^-+|-+$/g,''); }
      async function fetchPosts() { try { const r=await fetch('../posts/data/posts.json'); if(!r.ok) return []; return await r.json(); } catch(e){ return [] } }
      function download(filename, content, mime='text/html') { const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);} 

      document.getElementById('preview').addEventListener('click', async ()=>{
        const title = document.getElementById('title').value.trim();
        if (!title) return alert('Enter a title');
        let slug = document.getElementById('slug').value.trim();
        if (!slug) slug = slugify(title);
        let date = document.getElementById('date').value.trim();
        if (!date) date = new Date().toISOString().slice(0,10);
        const excerpt = document.getElementById('excerpt').value.trim();
        const content = document.getElementById('content').value.trim();
        const posts = await fetchPosts();
        const exists = posts.find(p=>p.slug===slug);
        if (exists && !confirm('A post with this slug exists — overwrite in generated JSON?')) return;
        // build updated posts array (append or replace)
        const updated = posts.filter(p=>p.slug!==slug);
        updated.push({slug, title, date, excerpt, content});
        updated.sort((a,b)=> (a.date<b.date)?1: -1);
        const json = JSON.stringify(updated, null, 2);
        const postHtml = `<!doctype html>\n<html lang="en">\n<head>\n<meta charset="utf-8">\n<meta name="viewport" content="width=device-width,initial-scale=1">\n<title>${title}</title>\n<link rel=\"stylesheet\" href=\"../style.css\">\n</head>\n<body>\n<nav id=\"desktop-nav\">\n  <div class=\"logo\">Sabbir Hossen</div>\n</nav>\n<main style=\"margin:4rem 10rem;\">\n<article class=\"post\">\n<h1>${title}</h1>\n<div class=\"post-date\">${date}</div>\n<div class=\"post-content\">${content}</div>\n</article>\n</main>\n</body>\n</html>`;
        document.getElementById('result').textContent = json;
        // store for download buttons
        document.getElementById('download-json').dataset.json = json;
        document.getElementById('download-post').dataset.html = postHtml;
        document.getElementById('download-post').dataset.slug = slug;
      });

      document.getElementById('download-json').addEventListener('click', (e)=>{
        const json = e.target.dataset.json;
        if (!json) return alert('Build first using Preview & Build');
        download('posts.json', json, 'application/json');
      });

      document.getElementById('download-post').addEventListener('click', (e)=>{
        const html = e.target.dataset.html; const slug = e.target.dataset.slug || 'post';
        if (!html) return alert('Build first using Preview & Build');
        download(slug + '.html', html, 'text/html');
      });
    </script>
  </body>
</html>
